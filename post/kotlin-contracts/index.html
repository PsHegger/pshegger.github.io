<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>pshegger - Help Yourself and the Compiler with Contracts </title>
    
    
    <meta content="programming, kotlin, contracts" name="keywords">
    
    <meta content="pshegger - In the world of Kotlin, contracts represent a deal between the developer and the compiler. As a developer you can share insight of your code with the compiler and it can use this extra info for better code analysis." name="description">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    

    

    
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-72812058-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments)};
          gtag('js', new Date());
          gtag('config', 'UA-72812058-1');
        </script>
    

    

    <link rel="stylesheet" href="/layui/css/layui.css">
    <link rel="stylesheet" href="/self/css/default.css">
    <script src="/layui/layui.js"></script>

    <link rel="stylesheet" async href="/self/css/markdown.min.css">
    <link rel="stylesheet" async href="/self/css/gallery.css">
    
    
    

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
    <script async src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js" integrity="sha256-h2tMEmhemR2IN4wbbdNjj9LaDIjzwk2hralQwfJmBOE=" crossorigin="anonymous"></script></head>

<body>
    
    <header class="layui-header layui-bg-cyan">

    
    
    <a class="nav-self-logo" href="/">
        pshegger
    </a>

    <ul class="layui-nav layui-layout-right layui-bg-cyan" lay-filter="">
        
        
        <li class="layui-nav-item" id="nav_big"><a href="/post/">Posts</a></li>
        

        
            
                <li class="layui-nav-item" id="nav_big"><a href="/about/">About</a></li>
            
        

        
        <li class="layui-nav-item" id="nav_small">
            <a href="javascript:;">
                <i class="layui-icon layui-icon-app" style="font-size: 24px;"></i>
            </a>

            <dl class="layui-nav-child">
                
                <dd><a href="/post/">Posts</a></dd>
                

                
                    
                        <dd><a href="/about/">About</a></dd>
                    
                
            </dl>
        </li>
    </ul>
</header>

<script>
layui.use('element', function(){
  var element = layui.element;
});
</script>
        <div id="content" style="min-height:80%">
<div class="layui-container" style="margin-bottom: 10px">
    

    <div class="layui-row layui-col-space10">
        <div class="layui-col-md8 layui-col-sm12 layui-col-xs12">
            <div class="layui-card single-card">
                <br />
                <blockquote class="self-elem-quote self-elem-quote-bg-orange markdown-body single-title" >
                    <h1>Help Yourself and the Compiler with Contracts</h1>
                    <h3 style="margin-top:10px; margin-bottom:10px"> 
    <i class="layui-icon layui-icon-date" style="font-size: 28px; vertical-align: -2px;"></i>
    <span>2019-03-21</span>

    
     
    <i class="layui-icon layui-icon-list" style="font-size: 32px; vertical-align: -3px;"></i>
    

    
        <a href="/categories/kotlin/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">kotlin</span>
        </a>
    

    
    <i class="layui-icon layui-icon-tabs" style="font-size: 22px; vertical-align: 1px;margin-right:2px;"></i>
    

    
        <a href="/tags/programming/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">programming</span>
        </a>
    
        <a href="/tags/kotlin/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">kotlin</span>
        </a>
    
        <a href="/tags/contracts/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">contracts</span>
        </a>
    
    
</h3>
                </blockquote>
                <div class="layui-card-body markdown-body single-content">
                    <h2 id="what-are-contracts">What are contracts?</h2>
<p>In the world of Kotlin, contracts represent a deal between the developer and the compiler. As a developer you can share insight of your code with the compiler and it can use this extra info for better code analysis.</p>
<p>Currently there are two kinds of contracts available: <code>callsInPlace</code> which tells the compiler how many times a lambda is called, and <code>returns</code>/<code>implies</code> which indicates that a defined condition is true if the function returns a specific value.</p>
<h2 id="basic-usage">Basic usage</h2>
<p>In order to write contracts for your own functions you have to keep in mind a few things. First of all this feature is experimental in Kotlin 1.3, so you have to annotate your functions with <code>@ExperimentalContracts</code>. These functions also have to be top-level functions or your code will fail to compile.</p>
<p>With these in mind let&rsquo;s see how a function with a contract looks like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">@ExperimentalContracts
<span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">foo</span>() {
    contract {
        <span style="color:#75715e">// your contract definition
</span><span style="color:#75715e"></span>    }
    <span style="color:#75715e">// some other code
</span><span style="color:#75715e"></span>}
</code></pre></div><p>To write the actual definition we will be using the Contract DSL.</p>
<h2 id="callsinplace">callsInPlace</h2>
<p>Let&rsquo;s take a look at the following example: you want to put a delay in your code, but the value and the unit is stored separately. You decide to write a function which reads the values and passes them back using a lambda.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">readDelay</span>(callback: (Long, TimeUnit) -&gt; Unit) {
    <span style="color:#66d9ef">val</span> value = readDelayValue()
    <span style="color:#66d9ef">val</span> unit = readDelayUnit()
    callback(value, unit)
}
</code></pre></div><p>You would like to store the values for later use so you create variables for them:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">val</span> delayValue: Long
<span style="color:#66d9ef">val</span> delayUnit: TimeUnit
    
readDelay { value, unit -&gt;
    delayValue = value
    delayUnit = unit
}
    
Thread.sleep(delayUnit.toMillis(delayValue))
</code></pre></div><p>The problem is that this code will not compile because the compiler has no idea how many times the lambda will be called. If it&rsquo;s not called at all the two variables would be uninitialized and if it&rsquo;s called more than once they would be reassigned, which is forbidden. Luckily we have <code>callsInPlace</code> which is exactly what we need now. Let&rsquo;s modify our reader function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">@ExperimentalContracts
<span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">readDelay</span>(callback: (Long, TimeUnit) -&gt; Unit) {
    contract {
        callsInPlace(callback, InvocationKind.EXACTLY_ONCE)
    }
    
    <span style="color:#66d9ef">val</span> value = readDelayValue()
    <span style="color:#66d9ef">val</span> unit = readDelayUnit()
    callback(value, unit)
}
</code></pre></div><p>The main logic is the same as before, but we added a contract to our function. This tells the compiler that the lambda will be called exactly once (<code>InvocationKind.EXACTLY_ONCE</code>). With that knowledge the compiler will know that the variables will be initialized and will not be reassigned.</p>
<p>There are 3 other possible invocation kinds: <code>AT_MOST_ONCE</code> (the lambda will be called once or not at all), <code>AT_LEAST_ONCE</code> (it will be called one or more times) and <code>UNKNOWN</code> (it will be called, but we don&rsquo;t know how many times).</p>
<h2 id="returnsimplies">returns/implies</h2>
<p>The other type of contract we can write tells the compiler that a specific condition is true if the function returns with the specified value. Let&rsquo;s take a look at the following code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">@ExperimentalContracts
<span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">String</span><span style="color:#f92672">?.</span>isValid(): Boolean {
    contract {
        returns(<span style="color:#66d9ef">true</span>) implies (<span style="color:#66d9ef">this</span>@isValid <span style="color:#66d9ef">is</span> String)
    }
    
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span> != <span style="color:#66d9ef">null</span> &amp;&amp; <span style="color:#66d9ef">this</span>.length &gt; <span style="color:#ae81ff">3</span>
}
</code></pre></div><p>We can see that other kind of contract in this example, but what does it exactly do? To understand it better let&rsquo;s break it down to pieces. The first part (<code>returns(true)</code>) indicates that the contract applies when this function returns <code>true</code> as its result, and the second part tells the compiler what to expect from it. In this case it indicates that the particular <code>String?</code> instance we&rsquo;re calling this function on is in fact a <code>String</code> and in reality it&rsquo;s not nullable. From this the compiler knows that if the function returns <code>true</code> it&rsquo;s safe to smart-case the instance to a non-nullable type. This is how it looks when we try to use it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">val</span> result: String? = getResult()
        
<span style="color:#66d9ef">if</span> (result.isValid()) {
    println(<span style="color:#e6db74">&#34;The length of the result is ${result.length}&#34;</span>)
}
</code></pre></div><p>As you can see we didn&rsquo;t have to use <code>String?.length</code>, because <code>result</code> has been smart-casted to <code>String</code>. Without the contract we would either had to check for nullability in the <code>if</code> expression or use the safe call operator (<code>?.</code>).</p>
<p>Currently there are 3 types of return state indicators: <code>returns</code> (without any argument) expresses that the function returned successfully, <code>returns(Any?)</code> (currently only <code>true</code>, <code>false</code> and <code>null</code> is supported) expresses that the function returned successfully with the given value and <code>returnsNotNull</code> which expresses that the returned value is not null. The syntax is the same for all 3 types: <code>*type* implies *expression*</code>.</p>
<h2 id="a-few-things-to-keep-in-mind">A few things to keep in mind</h2>
<p>When writing your contracts there are a few things to keep in mind. First of all, contracts are not verified, which means that you can write a function with a wrong contract and this may lead to unexpected errors at <strong>runtime</strong>.</p>
<p>The other important thing to remember is that contracts are an experimental feature in Kotlin 1.3 and because of that the syntax may change in the future, so you might want to wait until its stable release to use it in production.</p>
</div>
            </div>
        </div>

        <div class="layui-col-md4 layui-col-sm12 layui-col-xs12">
            

            <div class="layui-card single-card">
                <h2 class="single-title">Recent Posts</h2>
            
                
                <div style="margin-left: 10px;">
                    <blockquote class="self-elem-quote self-elem-quote-bg-orange" style="background-color:#FFFFFF;margin-top: 10px;">
                    <a href="/post/renderscript/">
                        <h3 class="">RenderScript is Still alive</h3>
                    </a>
                    <h3 style="margin-top:10px; margin-bottom:10px"> 
    <i class="layui-icon layui-icon-date" style="font-size: 28px; vertical-align: -2px;"></i>
    <span>2020-02-29</span>

    
     
    <i class="layui-icon layui-icon-list" style="font-size: 32px; vertical-align: -3px;"></i>
    

    
        <a href="/categories/android/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">android</span>
        </a>
    

    
    <i class="layui-icon layui-icon-tabs" style="font-size: 22px; vertical-align: 1px;margin-right:2px;"></i>
    

    
        <a href="/tags/programming/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">programming</span>
        </a>
    
        <a href="/tags/android/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">android</span>
        </a>
    
        <a href="/tags/renderscript/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">renderscript</span>
        </a>
    
        <a href="/tags/parallelism/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">parallelism</span>
        </a>
    
    
</h3>
                    </blockquote>
                </div>
                
                <div style="margin-left: 10px;">
                    <blockquote class="self-elem-quote self-elem-quote-bg-orange" style="background-color:#FFFFFF;margin-top: 10px;">
                    <a href="/post/grpc-talk/">
                        <h3 class="">gRPC for Kotliners</h3>
                    </a>
                    <h3 style="margin-top:10px; margin-bottom:10px"> 
    <i class="layui-icon layui-icon-date" style="font-size: 28px; vertical-align: -2px;"></i>
    <span>2019-11-14</span>

    
     
    <i class="layui-icon layui-icon-list" style="font-size: 32px; vertical-align: -3px;"></i>
    

    
        <a href="/categories/android/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">android</span>
        </a>
    
        <a href="/categories/kotlin/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">kotlin</span>
        </a>
    
        <a href="/categories/talks/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">talks</span>
        </a>
    

    
    <i class="layui-icon layui-icon-tabs" style="font-size: 22px; vertical-align: 1px;margin-right:2px;"></i>
    

    
        <a href="/tags/kotlin/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">kotlin</span>
        </a>
    
        <a href="/tags/android/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">android</span>
        </a>
    
        <a href="/tags/grpc/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">grpc</span>
        </a>
    
    
</h3>
                    </blockquote>
                </div>
                
                <div style="margin-left: 10px;">
                    <blockquote class="self-elem-quote self-elem-quote-bg-orange" style="background-color:#FFFFFF;margin-top: 10px;">
                    <a href="/post/generate-for-me/">
                        <h3 class="">@GenerateForMe</h3>
                    </a>
                    <h3 style="margin-top:10px; margin-bottom:10px"> 
    <i class="layui-icon layui-icon-date" style="font-size: 28px; vertical-align: -2px;"></i>
    <span>2019-11-11</span>

    
     
    <i class="layui-icon layui-icon-list" style="font-size: 32px; vertical-align: -3px;"></i>
    

    
        <a href="/categories/kotlin/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">kotlin</span>
        </a>
    

    
    <i class="layui-icon layui-icon-tabs" style="font-size: 22px; vertical-align: 1px;margin-right:2px;"></i>
    

    
        <a href="/tags/programming/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">programming</span>
        </a>
    
        <a href="/tags/kotlin/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">kotlin</span>
        </a>
    
        <a href="/tags/annotation/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">annotation</span>
        </a>
    
        <a href="/tags/kapt/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">kapt</span>
        </a>
    
    
</h3>
                    </blockquote>
                </div>
                
                <div style="margin-left: 10px;">
                    <blockquote class="self-elem-quote self-elem-quote-bg-orange" style="background-color:#FFFFFF;margin-top: 10px;">
                    <a href="/post/kotlin-contracts/">
                        <h3 class="">Help Yourself and the Compiler with Contracts</h3>
                    </a>
                    <h3 style="margin-top:10px; margin-bottom:10px"> 
    <i class="layui-icon layui-icon-date" style="font-size: 28px; vertical-align: -2px;"></i>
    <span>2019-03-21</span>

    
     
    <i class="layui-icon layui-icon-list" style="font-size: 32px; vertical-align: -3px;"></i>
    

    
        <a href="/categories/kotlin/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">kotlin</span>
        </a>
    

    
    <i class="layui-icon layui-icon-tabs" style="font-size: 22px; vertical-align: 1px;margin-right:2px;"></i>
    

    
        <a href="/tags/programming/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">programming</span>
        </a>
    
        <a href="/tags/kotlin/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">kotlin</span>
        </a>
    
        <a href="/tags/contracts/">
            <span class="layui-badge layui-bg-green" style="vertical-align: 2px;">contracts</span>
        </a>
    
    
</h3>
                    </blockquote>
                </div>
                
            
            <br />
            </div>
        </div>

    </div>
</div>


        </div><footer>
    
    
    <div class="layui-container">
        <p class="copyright">&copy; All rights reserved. Powered by <a href='https://gohugo.io' style='color:#FFFFFF'>Hugo</a> and <a href='https://github.com/ertuil/erblog' style='color:#FFFFFF'>Erblog</a>.</p>
    </div>
</footer>
</body>
</html>
